<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç¤¾ä¼šå®è·µå°åŠ©æ‰‹ - æ™ºèƒ½ç­”ç–‘å¹³å°</title>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== å…¨å±€æ ·å¼é‡ç½® ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "PingFang SC", "Hiragino Sans GB", sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(120deg, #f5f7fa, #e4eaf5);
            color: #333;
            position: relative;
            padding-bottom: 60px;
            opacity: 1;
            transition: opacity 0.6s ease;
            overflow-x: hidden;
            overflow-y: auto;
            height: auto;
        }

        body.loading { opacity: 0.85; }

        /* ===== å¤´éƒ¨æ ·å¼ ===== */
        .page-header {
            background: #2c68c8;
            color: white;
            padding: 1.2rem 3%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 3rem;
            position: relative;
            z-index: auto;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .header-desc {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 0.3rem;
            font-weight: 400;
        }

        .header-nav a {
            color: white;
            text-decoration: none;
            margin-left: 1.5rem;
            font-size: 0.95rem;
            transition: opacity 0.3s;
            cursor: pointer;
        }

        .header-nav a:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        /* ===== å››å¤§åŠŸèƒ½æ¿å— ===== */
        .feature-section {
            max-width: 1400px;
            margin: 0 auto 4rem;
            padding: 0 3%;
            position: relative;
            z-index: auto;
        }
        .feature-title {
            text-align: center;
            font-size: 1.6rem;
            color: #2c68c8;
            margin-bottom: 2rem;
            font-weight: 600;
        }
        .feature-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }
        .feature-card {
            background: white;
            padding: 2rem 1.8rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(44,104,200,0.08);
            transition: all 0.3s ease;
            text-align: center;
        }
        .feature-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 8px 25px rgba(44,104,200,0.15);
        }
        .feature-card i {
            font-size: 2.2rem;
            color: #2c68c8;
            margin-bottom: 1.2rem;
        }
        .feature-card h3 {
            font-size: 1.3rem;
            color: #2c68c8;
            margin-bottom: 0.8rem;
            font-weight: 600;
        }
        .feature-card p {
            color: #666;
            line-height: 1.7;
            font-size: 0.95rem;
        }

        /* ===== å¼•å¯¼æŒ‰é’® ===== */
        .guide-btn {
            text-align: center;
            margin-bottom: 3rem;
            padding: 0 3%;
            position: relative;
            z-index: auto;
        }
        .enter-chat {
            background: #2c68c8;
            color: white;
            border: none;
            padding: 1rem 2.2rem;
            font-size: 1.15rem;
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(44,104,200,0.2);
            transition: all 0.3s;
        }
        .enter-chat:hover {
            background: #1e4f9e;
            transform: translateY(-2px);
        }
        .enter-chat:disabled {
            background: #95b3e0;
            cursor: not-allowed;
            transform: none;
        }

        .token-status {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #2c68c8;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .token-status i { font-size: 1rem; }
        .token-status.success { color: #28a745; }
        .token-status.error { color: #dc3545; }

        /* ===== é¡µé¢åº•éƒ¨ ===== */
        .page-footer {
            text-align: center;
            padding: 1rem;
            color: #888;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 200;
            backdrop-filter: blur(4px);
        }
        .page-footer a {
            color: #2c68c8;
            text-decoration: none;
            margin: 0 0.3rem;
            cursor: pointer;
        }

        /* ===== ç¾åŒ–åçš„èŠå¤©æ¡†å®¹å™¨ - å¼•å¯¼å¡ç‰‡é£æ ¼ ===== */
        #position_demo {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            width: 0;
            height: 0;
            visibility: hidden;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(145deg, #ffffff, #f8faff);
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(44,104,200,0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(44,104,200,0.1);
        }

        /* æ¿€æ´»çŠ¶æ€ - å¼•å¯¼å¡ç‰‡å®Œå…¨æ˜¾ç¤º */
        #position_demo.coze-active {
            width: 900px;
            height: 600px;
            visibility: visible;
            opacity: 1;
        }

        /* å¼•å¯¼å¡ç‰‡å¤´éƒ¨ */
        .coze-guide-header {
            background: linear-gradient(135deg, #2c68c8, #1e4f9e);
            padding: 30px 40px;
            color: white;
            position: relative;
        }

        .coze-guide-header h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .coze-guide-header p {
            font-size: 1rem;
            opacity: 0.9;
            margin-left: 50px;
        }

        /* è‡ªå®šä¹‰å…³é—­æŒ‰é’® */
        .coze-guide-close {
            position: absolute;
            top: 20px;
            right: 25px;
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(4px);
        }

        .coze-guide-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        /* å¼•å¯¼å¡ç‰‡ä¸»ä½“ */
        .coze-guide-body {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            background: linear-gradient(145deg, #ffffff, #fafcff);
        }

        .coze-guide-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #2c68c8, #1e4f9e);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(44,104,200,0.2);
        }

        .coze-guide-icon i {
            font-size: 48px;
            color: white;
        }

        .coze-guide-body h3 {
            font-size: 1.6rem;
            color: #2c68c8;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .coze-guide-body p {
            font-size: 1.1rem;
            color: #666;
            line-height: 1.8;
            max-width: 500px;
            margin-bottom: 30px;
        }

        .coze-guide-tip {
            background: rgba(44,104,200,0.08);
            padding: 15px 25px;
            border-radius: 50px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: #2c68c8;
            font-weight: 500;
            border: 1px solid rgba(44,104,200,0.2);
        }

        .coze-guide-tip i {
            font-size: 1.2rem;
        }

        /* PCç«¯å…¨å±æ¨¡å¼ - çœŸæ­£çš„èŠå¤©ç•Œé¢ */
        @media (min-width: 769px) {
            #position_demo.coze-active.coze-fullscreen {
                width: 95vw !important;
                height: 90vh !important;
                max-width: 1400px !important;
                max-height: 90vh !important;
                left: 50% !important;
                top: 50% !important;
                transform: translate(-50%, -50%) !important;
                border-radius: 16px !important;
                box-shadow: 0 25px 50px rgba(0,0,0,0.2) !important;
                background: white !important;
            }
            
            /* å…¨å±æ—¶éšè—å¼•å¯¼å¡ç‰‡å¤´éƒ¨å’Œä¸»ä½“ï¼Œæ˜¾ç¤ºSDKå†…å®¹ */
            #position_demo.coze-active.coze-fullscreen .coze-guide-header,
            #position_demo.coze-active.coze-fullscreen .coze-guide-body {
                display: none !important;
            }
            
            /* å…¨å±æ—¶éšè—å®˜æ–¹æ‚¬æµ®çƒ */
            #position_demo.coze-active.coze-fullscreen ~ [data-testid="assistant-btn"],
            #position_demo.coze-active.coze-fullscreen ~ .assistant-btn,
            #position_demo.coze-active.coze-fullscreen ~ button[class*="assistant"] {
                display: none !important;
            }
        }

        /* ===== æ¨¡æ€å¼¹çª— ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            transition: color 0.2s;
        }
        .modal-close:hover { color: #333; }
        .modal-title {
            font-size: 1.3rem;
            color: #2c68c8;
            margin-bottom: 1.5rem;
            font-weight: 600;
            border-bottom: 2px solid #eef2f7;
            padding-bottom: 0.8rem;
        }

        /* æ¨¡æ¿é€‰æ‹©æŒ‰é’®ç»„ */
        .template-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }
        .template-btn {
            background: #f0f4fa;
            border: 1px solid #d0ddee;
            padding: 0.8rem 2rem;
            border-radius: 6px;
            font-size: 1rem;
            color: #2c68c8;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        .template-btn:hover {
            background: #2c68c8;
            color: white;
            border-color: #2c68c8;
        }

        /* ===== ç§»åŠ¨ç«¯é€‚é… ===== */
        @media (max-width: 768px) {
            .page-header { padding: 1rem 3%; margin-bottom: 2rem; }
            .header-nav { width: 100%; margin-top: 0.5rem; }
            .header-nav a { margin-left: 0.8rem; font-size: 0.9rem; }
            .header-title { font-size: 1.5rem; }
            .header-desc { font-size: 0.9rem; }
            .feature-section { max-width: 100%; margin-bottom: 2.5rem; }
            .feature-title { font-size: 1.4rem; margin-bottom: 1.5rem; }
            .feature-cards { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
            .feature-card { padding: 1.2rem 0.8rem; }
            .feature-card i { font-size: 1.8rem; margin-bottom: 0.8rem; }
            .feature-card h3 { font-size: 1.1rem; margin-bottom: 0.6rem; }
            .feature-card p { font-size: 0.85rem; line-height: 1.6; }
            .enter-chat { font-size: 0.95rem; padding: 0.8rem 1.2rem; width: 95%; justify-content: center; }
            
            /* ç§»åŠ¨ç«¯å¼•å¯¼å¡ç‰‡ */
            #position_demo.coze-active {
                width: 92% !important;
                height: 70vh !important;
            }
            
            .coze-guide-header {
                padding: 20px !important;
            }
            
            .coze-guide-header h2 {
                font-size: 1.3rem !important;
            }
            
            .coze-guide-body {
                padding: 20px !important;
            }
            
            .coze-guide-icon {
                width: 70px !important;
                height: 70px !important;
            }
            
            .coze-guide-icon i {
                font-size: 32px !important;
            }
            
            .coze-guide-body h3 {
                font-size: 1.3rem !important;
            }
            
            .coze-guide-body p {
                font-size: 0.95rem !important;
            }
            
            [data-testid="assistant-btn"] { 
                bottom: 70px !important; 
                right: 10px !important; 
                width: 50px !important; 
                height: 50px !important; 
            }
            
            .modal-content { width: 95%; padding: 1.5rem; }
            .template-buttons { flex-direction: column; }
        }
        @media (max-width: 480px) {
            .header-title { font-size: 1.3rem; }
            .feature-title { font-size: 1.2rem; }
            .page-footer { font-size: 0.8rem; padding: 0.7rem; }
            #position_demo.coze-active { height: 75vh !important; }
        }
    </style>
</head>

<body class="loading">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <header class="page-header">
        <div>
            <h1 class="header-title">
                <i class="fas fa-hand-holding-heart"></i>
                ç¤¾ä¼šå®è·µå°åŠ©æ‰‹
            </h1>
            <p class="header-desc">ä½ çš„ä¸“å±AIç¤¾ä¼šå®è·µä¼™ä¼´ | ä¸€ç«™å¼è§£å†³å®è·µå…¨æµç¨‹éœ€æ±‚</p>
        </div>
        <nav class="header-nav">
            <a href="javascript:;" id="navGuide"><i class="fas fa-question-circle"></i> ä½¿ç”¨æŒ‡å—</a>
            <a href="javascript:;" id="navTemplate"><i class="fas fa-file-alt"></i> å®è·µæ¨¡æ¿</a>
            <a href="javascript:;" id="navAbout"><i class="fas fa-user-circle"></i> å…³äºæˆ‘ä»¬</a>
        </nav>
    </header>

    <!-- å››å¤§åŠŸèƒ½æ¿å— -->
    <section class="feature-section">
        <h2 class="feature-title">æ ¸å¿ƒåŠŸèƒ½ Â· ä¸ºä½ çš„ç¤¾ä¼šå®è·µä¿é©¾æŠ¤èˆª</h2>
        <div class="feature-cards">
            <div class="feature-card">
                <i class="fas fa-question-circle"></i>
                <h3>æ™ºèƒ½ç­”ç–‘</h3>
                <p>7*24å°æ—¶è§£ç­”ç¤¾ä¼šå®è·µç›¸å…³ç–‘é—®ï¼Œæ”¿ç­–è§£è¯»ã€æµç¨‹å’¨è¯¢ã€å¸¸è§é—®é¢˜å¿«é€Ÿå“åº”</p>
            </div>
            <div class="feature-card">
                <i class="fas fa-sitemap"></i>
                <h3>æ–¹æ¡ˆè§„åˆ’</h3>
                <p>æ ¹æ®å®è·µä¸»é¢˜ã€äººç¾¤ã€åœºåœ°ï¼Œæ™ºèƒ½ç”Ÿæˆä¸ªæ€§åŒ–å®è·µæ–¹æ¡ˆï¼Œå«æµç¨‹ã€æ—¶é—´ã€ç‰©æ–™å…¨è§„åˆ’</p>
            </div>
            <div class="feature-card">
                <i class="fas fa-lightbulb"></i>
                <h3>é—®é¢˜è§£å†³</h3>
                <p>é’ˆå¯¹å®è·µä¸­çªå‘é—®é¢˜ã€æ²Ÿé€šéš¾é¢˜ã€æ‰§è¡Œéšœç¢ï¼Œå¿«é€Ÿç»™å‡ºå¯è¡Œçš„è§£å†³æ€è·¯å’Œè½åœ°æ–¹æ³•</p>
            </div>
            <div class="feature-card">
                <i class="fas fa-book-reader"></i>
                <h3>ç»éªŒåˆ†äº«</h3>
                <p>æä¾›å„ç±»ä¼˜ç§€ç¤¾ä¼šå®è·µæ¡ˆä¾‹ã€ç»éªŒæŠ€å·§ï¼Œå¸®åŠ©ä½ è§„é¿è¯¯åŒºï¼Œæå‡å®è·µè´¨é‡å’Œæˆæœ</p>
            </div>
        </div>
    </section>

    <!-- å¼•å¯¼æŒ‰é’® -->
    <div class="guide-btn">
        <button class="enter-chat" id="openChat">
            <i class="fas fa-comment-dots"></i>
            å¼€å§‹æ™ºèƒ½å’¨è¯¢
        </button>
        <div id="tokenStatus" class="token-status">
            <i class="fas fa-sync-alt fa-spin"></i> æ­£åœ¨åˆå§‹åŒ–ç”¨æˆ·æ ‡è¯†...
        </div>
    </div>

    <!-- é¡µé¢åº•éƒ¨ -->
    <footer class="page-footer">
        Â© 2026 ç¤¾ä¼šå®è·µå°åŠ©æ‰‹ | ç”± Coze æä¾›æ™ºèƒ½æŠ€æœ¯æ”¯æŒ
    </footer>

    <!-- ç¾åŒ–åçš„èŠå¤©æ¡†å®¹å™¨ - å¼•å¯¼å¡ç‰‡ -->
    <div id="position_demo">
        <div class="coze-guide-header">
            <h2>
                <i class="fas fa-robot"></i>
                ç¤¾ä¼šå®è·µå°åŠ©æ‰‹
            </h2>
            <p>ä½ çš„ä¸“å±AIç¤¾ä¼šå®è·µä¼™ä¼´</p>
            <button id="closeGuideCard" class="coze-guide-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="coze-guide-body">
            <div class="coze-guide-icon">
                <i class="fas fa-hand-holding-heart"></i>
            </div>
            <h3>æ™ºèƒ½åŠ©ç†å·²å°±ç»ª</h3>
            <p>ç‚¹å‡»å³ä¸‹è§’æ‚¬æµ®çƒå¼€å¯å¯¹è¯<br>æˆ‘å°†ä¸ºä½ è§£ç­”ç¤¾ä¼šå®è·µä¸­çš„å„ç§é—®é¢˜</p>
            <div class="coze-guide-tip">
                <i class="fas fa-hand-pointer"></i>
                <span>ç‚¹å‡»å³ä¸‹è§’æœºå™¨äººå›¾æ ‡å¼€å§‹å’¨è¯¢</span>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€å¼¹çª— -->
    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-content">
            <span id="modalClose" class="modal-close">&times;</span>
            <div id="modalTitle" class="modal-title"></div>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- å¼•å…¥Coze Web SDK -->
    <script src="https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.2.0-beta.20/libs/cn/index.js"></script>
    
    <script>
        // ==================== 1. åŠ å¯†ç®—æ³•ç”Ÿæˆæµè§ˆå™¨å”¯ä¸€ç”¨æˆ·ID ====================
        async function generateBrowserFingerprint() {
            try {
                const features = {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    languages: navigator.languages?.join(','),
                    platform: navigator.platform,
                    hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                    deviceMemory: navigator.deviceMemory || 'unknown',
                    maxTouchPoints: navigator.maxTouchPoints,
                    screenWidth: screen.width,
                    screenHeight: screen.height,
                    screenColorDepth: screen.colorDepth,
                    screenPixelRatio: window.devicePixelRatio || 1,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    timezoneOffset: new Date().getTimezoneOffset(),
                    cookiesEnabled: navigator.cookieEnabled,
                    doNotTrack: navigator.doNotTrack,
                    localStorage: !!window.localStorage,
                    sessionStorage: !!window.sessionStorage,
                    canvasFingerprint: await getCanvasFingerprint(),
                    webglVendor: await getWebGLVendor(),
                    hour: Math.floor(Date.now() / (1000 * 60 * 60)),
                    salt: '2026_coze_social_practice'
                };

                const featureString = JSON.stringify(features, Object.keys(features).sort());
                const encoder = new TextEncoder();
                const data = encoder.encode(featureString);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return `fp_${hashHex.substring(0, 32)}`;
            } catch (error) {
                console.error('æŒ‡çº¹ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ:', error);
                return generateFallbackId();
            }
        }

        async function getCanvasFingerprint() {
            try {
                const canvas = document.createElement('canvas');
                canvas.width = 200;
                canvas.height = 50;
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillStyle = '#2c68c8';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#ffffff';
                ctx.fillText('ç¤¾ä¼šå®è·µå°åŠ©æ‰‹', 10, 15);
                return canvas.toDataURL().substring(0, 100);
            } catch (e) {
                return 'canvas_not_supported';
            }
        }

        async function getWebGLVendor() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (gl) {
                    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    if (debugInfo) {
                        return {
                            vendor: gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL),
                            renderer: gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL)
                        };
                    }
                }
            } catch (e) {}
            return 'unknown';
        }

        function generateFallbackId() {
            const userAgent = navigator.userAgent;
            const screenRes = `${screen.width}x${screen.height}`;
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const timestamp = Date.now();
            let hash = 0;
            const str = `${userAgent}|${screenRes}|${timezone}|${timestamp}|coze_fallback`;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return `fp_fallback_${Math.abs(hash).toString(16)}_${Date.now()}`;
        }

        // ==================== 2. å…¨å±€å˜é‡ ====================
        let my_access_token = null;
        let token_expire_time = null;
        let browserFingerprint = null;
        let cozeClient = null;
        let isInitialized = false;

        // ==================== 3. æœ¬åœ°åç«¯äº¤äº’ ====================
        async function fetchCozeAccessToken(userId) {
            const backendUrl = 'https://Yancynb.pythonanywhere.com/api/get_coze_token';
            const tokenStatus = document.getElementById('tokenStatus');
            
            try {
                tokenStatus.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> æ­£åœ¨è·å–Access Token...';
                tokenStatus.className = 'token-status';
                console.log('ğŸ”„ è¯·æ±‚åç«¯è·å–Access Tokenï¼Œç”¨æˆ·ID:', userId);
                
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId }),
                    signal: AbortSignal.timeout(10000)
                });

                const data = await response.json();

                if (data.success && data.access_token) {
                    my_access_token = data.access_token;
                    token_expire_time = Date.now() + (data.expires_in * 1000);
                    
                    sessionStorage.setItem('coze_access_token', my_access_token);
                    sessionStorage.setItem('coze_token_expire', token_expire_time.toString());
                    sessionStorage.setItem('coze_user_id', userId);
                    
                    console.log('âœ… Access Tokenè·å–æˆåŠŸ!');
                    
                    tokenStatus.innerHTML = '<i class="fas fa-check-circle"></i> Access Tokenè·å–æˆåŠŸï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹å’¨è¯¢';
                    tokenStatus.className = 'token-status success';
                    
                    return my_access_token;
                } else {
                    throw new Error(data.error || 'è·å–Tokenå¤±è´¥');
                }
            } catch (error) {
                console.error('âŒ è·å–Access Tokenå¤±è´¥:', error);
                if (error.name === 'TimeoutError' || error.message.includes('è¶…æ—¶')) {
                    tokenStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> è¿æ¥åç«¯è¶…æ—¶ï¼Œè¯·ç¡®è®¤FlaskæœåŠ¡æ˜¯å¦å¯åŠ¨';
                } else if (error.message.includes('Failed to fetch')) {
                    tokenStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> æ— æ³•è¿æ¥åˆ°åç«¯ï¼Œè¯·å¯åŠ¨FlaskæœåŠ¡ (python app.py)';
                } else {
                    tokenStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> è·å–Tokenå¤±è´¥: ${error.message.substring(0, 30)}...`;
                }
                tokenStatus.className = 'token-status error';
                throw error;
            }
        }

        async function getValidAccessToken() {
            if (!my_access_token) {
                try {
                    my_access_token = sessionStorage.getItem('coze_access_token');
                    token_expire_time = parseInt(sessionStorage.getItem('coze_token_expire') || '0');
                    browserFingerprint = sessionStorage.getItem('coze_user_id');
                } catch (e) {}
            }
            
            if (my_access_token && token_expire_time > Date.now() + 300000) {
                console.log('âœ… ä½¿ç”¨ç¼“å­˜çš„Access Token');
                return my_access_token;
            }
            
            console.log('ğŸ”„ Tokenæ— æ•ˆæˆ–å³å°†è¿‡æœŸï¼Œé‡æ–°è·å–...');
            
            if (!browserFingerprint) {
                browserFingerprint = await generateBrowserFingerprint();
                sessionStorage.setItem('coze_user_id', browserFingerprint);
            }
            
            return await fetchCozeAccessToken(browserFingerprint);
        }

        // ==================== 4. åˆå§‹åŒ–CozeèŠå¤© ====================
        async function initCozeChat(fullscreen = true) {
            const openChatBtn = document.getElementById('openChat');
            const tokenStatus = document.getElementById('tokenStatus');
            const chatContainer = document.getElementById('position_demo');
            
            if (isInitialized) {
                console.log('CozeèŠå¤©å·²åˆå§‹åŒ–ï¼Œç›´æ¥æ˜¾ç¤ºçª—å£');
                if (window.innerWidth > 768 && fullscreen) {
                    chatContainer.classList.add('coze-fullscreen');
                    // å…¨å±æ—¶éšè—å¼•å¯¼å¡ç‰‡å†…å®¹ï¼Œæ˜¾ç¤ºSDKèŠå¤©ç•Œé¢
                }
                if (cozeClient && cozeClient.showChatWindow) {
                    cozeClient.showChatWindow();
                }
                return;
            }
            
            try {
                openChatBtn.disabled = true;
                openChatBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆå§‹åŒ–ä¸­...';
                
                if (!browserFingerprint) {
                    browserFingerprint = await generateBrowserFingerprint();
                    sessionStorage.setItem('coze_user_id', browserFingerprint);
                    console.log('ğŸ†” æµè§ˆå™¨æŒ‡çº¹ID:', browserFingerprint);
                }
                
                const token = await getValidAccessToken();
                const isMobile = window.innerWidth <= 768;
                
                cozeClient = new CozeWebSDK.WebChatClient({
                    container: chatContainer,
                    config: {
                        type: 'bot',
                        bot_id: '7601815963067760682',
                        isIframe: false,
                    },
                    auth: {
                        type: 'token',
                        token: token,
                        onRefreshToken: async () => {
                            console.log('ğŸ”„ Tokenè¿‡æœŸï¼Œæ­£åœ¨åˆ·æ–°...');
                            return await getValidAccessToken();
                        }
                    },
                    userInfo: {
                        id: browserFingerprint,
                        url: 'https://lf-coze-web-cdn.coze.cn/obj/eden-cn/lm-lgvj/ljhwZthlaukjlkulzlp/coze/coze-logo.png',
                        nickname: 'æœ‰ç–‘é—®çš„å°æœ‹å‹',
                    },
                    ui: {
                        base: {
                            icon: 'https://lf-coze-web-cdn.coze.cn/obj/eden-cn/lm-lgvj/ljhwZthlaukjlkulzlp/coze/chatsdk-logo.png',
                            layout: isMobile ? 'mobile' : 'pc',
                            lang: 'zh-CN',
                            zIndex: 1000,
                        },
                        header: {
                            isShow: true,
                            isNeedClose: true,
                        },
                        asstBtn: {
                            isNeed: true,
                            icon: 'https://lf-coze-web-cdn.coze.cn/obj/eden-cn/lm-lgvj/ljhwZthlaukjlkulzlp/coze/assistant-btn-icon.png',
                            position: {
                                bottom: isMobile ? 70 : 20,
                                right: isMobile ? 10 : 20,
                            }
                        },
                        footer: {
                            isShow: true,
                            expressionText: 'ç”± coze æä¾›æ™ºèƒ½æŠ€æœ¯æ”¯æŒ',
                        },
                        conversations: {
                            isNeed: true,
                        },
                        chatBot: {
                            title: 'ç¤¾ä¼šå®è·µå°åŠ©æ‰‹',
                            uploadable: true,
                            width: isMobile ? '100%' : (fullscreen && window.innerWidth > 768 ? '95vw' : 900),
                            height: isMobile ? '85vh' : (fullscreen && window.innerWidth > 768 ? '90vh' : 600),
                            isNeedAudio: false,
                            isNeedFunctionCallMessage: true,
                            isNeedAddNewConversation: true,
                            isNeedQuote: true,
                            feedback: {
                                isNeedFeedback: true,
                                feedbackPanel: {
                                    title: 'æ‚¨å¯¹è¿™ä¸ªå®è·µè§£ç­”æœ‰ä»€ä¹ˆçœ‹æ³•ï¼Ÿè¯·å‘Šè¯‰æˆ‘ä»¬',
                                    placeholder: 'è¯·è¯¦ç»†æè¿°æ‚¨çš„é—®é¢˜æˆ–å»ºè®®...',
                                    tags: [
                                        { label: 'è§£ç­”ä¸å¤Ÿè¯¦ç»†', isNeedDetail: false },
                                        { label: 'è§£ç­”å†…å®¹é”™è¯¯', isNeedDetail: false },
                                        { label: 'ä¸ç¬¦åˆå®è·µéœ€æ±‚', isNeedDetail: true },
                                        { label: 'å…¶ä»–é—®é¢˜', isNeedDetail: true },
                                    ],
                                },
                            },
                        },
                    },
                });
                
                isInitialized = true;
                
                openChatBtn.disabled = false;
                openChatBtn.innerHTML = '<i class="fas fa-comment-dots"></i> ç‚¹å‡»å³ä¸‹è§’æ‚¬æµ®çƒç»§ç»­æ™ºèƒ½å’¨è¯¢';
                
                tokenStatus.innerHTML = '<i class="fas fa-check-circle"></i> èŠå¤©çª—å£å·²æ‰“å¼€ï¼Œå¯ä»¥å¼€å§‹å’¨è¯¢äº†ï¼';
                tokenStatus.className = 'token-status success';
                
                // æ¿€æ´»å¼•å¯¼å¡ç‰‡ï¼ˆä¸æ˜¯å…¨å±æ¨¡å¼ï¼‰
                chatContainer.classList.add('coze-active');
                
                console.log('ğŸ‰ CozeèŠå¤©åˆå§‹åŒ–å®Œæˆï¼');
                
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–CozeèŠå¤©å¤±è´¥:', error);
                openChatBtn.disabled = false;
                openChatBtn.innerHTML = '<i class="fas fa-comment-dots"></i> é‡æ–°å°è¯•è¿æ¥';
                tokenStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> åˆå§‹åŒ–å¤±è´¥: ${error.message}`;
                tokenStatus.className = 'token-status error';
            }
        }

        // ==================== 5. å…³é—­å¼•å¯¼å¡ç‰‡ ====================
        function closeGuideCard() {
            const chatContainer = document.getElementById('position_demo');
            chatContainer.classList.remove('coze-active');
            chatContainer.classList.remove('coze-fullscreen');
            
            if (cozeClient && cozeClient.hideChatWindow) {
                cozeClient.hideChatWindow();
            }
            
            console.log('å¼•å¯¼å¡ç‰‡å·²å…³é—­');
        }

        // ==================== 6. æ¨¡æ€å¼¹çª—æ§åˆ¶ ====================
        const modalOverlay = document.getElementById('modalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalClose = document.getElementById('modalClose');

        function openModal(title, content) {
            modalTitle.innerText = title;
            if (typeof content === 'string') {
                modalBody.innerHTML = content;
            } else {
                modalBody.innerHTML = '';
                modalBody.appendChild(content);
            }
            modalOverlay.classList.add('active');
        }

        function closeModal() {
            modalOverlay.classList.remove('active');
        }

        modalClose.addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', function(e) {
            if (e.target === modalOverlay) closeModal();
        });

        // ==================== 7. å…³äºæˆ‘ä»¬ ====================
        function showAbout() {
            const content = '<p style="font-size: 1.1rem; line-height: 1.8; color: #333;">æœ¬å®è·µç­”ç–‘åŠ©æ‰‹ç”±Yancyå’Œä»–çš„å°ä¼™ä¼´ä»¬å®Œæˆåˆ¶ä½œï¼Œå›ç­”ä»…ä¾›å‚è€ƒï¼Œå› å›ç­”é€ æˆçš„ä¸€åˆ‡åæœç”±ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ‹…ã€‚</p>';
            openModal('å…³äºæˆ‘ä»¬', content);
        }

        // ==================== 8. å®è·µæ¨¡æ¿ ====================
        function showTemplate() {
            const container = document.createElement('div');
            container.style.textAlign = 'center';
            
            const btnGroup = document.createElement('div');
            btnGroup.className = 'template-buttons';
            
            const btn1 = document.createElement('button');
            btn1.className = 'template-btn';
            btn1.innerText = 'æ¨¡æ¿ä¸€ï¼šçº¢è‰²ç”µæ³¢Â·å»¶å®‰å®è·µ';
            btn1.onclick = () => { window.open('https://mp.weixin.qq.com/s/0zSuJ5tVCZQ79vk9DSBStQ', '_blank'); };
            
            const btn2 = document.createElement('button');
            btn2.className = 'template-btn';
            btn2.innerText = 'æ¨¡æ¿äºŒï¼šä¹¡æ‘æŒ¯å…´Â·è°ƒç ”å®è·µ';
            btn2.onclick = () => { window.open('https://mp.weixin.qq.com/s/tnmOFtNvkwjCbpRcBgSuFQ', '_blank'); };
            
            btnGroup.appendChild(btn1);
            btnGroup.appendChild(btn2);
            container.appendChild(btnGroup);
            
            const desc = document.createElement('p');
            desc.style.marginTop = '1.5rem';
            desc.style.color = '#666';
            desc.style.fontSize = '0.9rem';
            desc.innerText = 'ç‚¹å‡»æŒ‰é’®æŸ¥çœ‹å®Œæ•´å®è·µæ¡ˆä¾‹ï¼ˆå°†æ‰“å¼€æ–°çª—å£ï¼‰';
            container.appendChild(desc);
            
            openModal('é€‰æ‹©å®è·µæ¨¡æ¿', container);
        }

        // ==================== 9. ä½¿ç”¨æŒ‡å— ====================
        function showGuide() {
            alert('ä½¿ç”¨æŒ‡å—ï¼šç‚¹å‡»â€œå¼€å§‹æ™ºèƒ½å’¨è¯¢â€æŒ‰é’®ï¼Œåœ¨æ‰“å¼€çš„å¼•å¯¼å¡ç‰‡ä¸­ç‚¹å‡»å³ä¸‹è§’æ‚¬æµ®çƒå³å¯å¼€å§‹å¯¹è¯ã€‚');
        }

        // ==================== 10. é¡µé¢åˆå§‹åŒ– ====================
        window.addEventListener('load', async () => {
            document.body.classList.remove('loading');
            
            // ç»‘å®šå¯¼èˆªäº‹ä»¶
            document.getElementById('navAbout').addEventListener('click', function(e) {
                e.preventDefault();
                showAbout();
            });
            
            document.getElementById('navTemplate').addEventListener('click', function(e) {
                e.preventDefault();
                showTemplate();
            });
            
            document.getElementById('navGuide').addEventListener('click', function(e) {
                e.preventDefault();
                showGuide();
            });
            
            // ç»‘å®šå¼€å§‹å’¨è¯¢æŒ‰é’®
            document.getElementById('openChat').addEventListener('click', function(e) {
                e.preventDefault();
                initCozeChat(true);
            });
            
            // ç»‘å®šå…³é—­å¼•å¯¼å¡ç‰‡æŒ‰é’®
            document.getElementById('closeGuideCard').addEventListener('click', function(e) {
                e.preventDefault();
                closeGuideCard();
            });
            
            // ç§»åŠ¨ç«¯æ ·å¼é€‚é…
            if (window.innerWidth <= 768) {
                const demoBox = document.getElementById('position_demo');
                demoBox.style.width = '92%';
                demoBox.style.height = '70vh';
            }
            
            // é¢„ç”Ÿæˆæµè§ˆå™¨æŒ‡çº¹
            const tokenStatus = document.getElementById('tokenStatus');
            try {
                browserFingerprint = await generateBrowserFingerprint();
                sessionStorage.setItem('coze_user_id', browserFingerprint);
                console.log('ğŸ†” æµè§ˆå™¨æŒ‡çº¹å·²ç”Ÿæˆ:', browserFingerprint);
                
                tokenStatus.innerHTML = '<i class="fas fa-check-circle"></i> ç”¨æˆ·æ ‡è¯†ç”ŸæˆæˆåŠŸï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹å’¨è¯¢';
                tokenStatus.className = 'token-status success';
                
                setTimeout(() => {
                    getValidAccessToken().catch(console.warn);
                }, 1000);
                
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                tokenStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                tokenStatus.className = 'token-status error';
            }
        });
    </script>
</body>
</html>